<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Movie Review</title>
    <link href="https://fonts.googleapis.com/css?family=Kanit|Merriweather"
      rel="stylesheet">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300&display=swap');
    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
    body {
      background-color: #1e1e1e;
      /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      color: #ffffff;
      /* ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
      font-family: 'Kanit', sans-serif;
      margin: 0;
      padding: 0;
    }

    /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 1.5em;
      font-size: 2.5em;
      font-weight: bold;
    }

    h2 {
      text-align: center;
      color: #0056b3;
      margin-bottom: 1.2em;
      font-size: 1.5em;
      font-weight: bold;
    }

    /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
    form,
    .search-section,
    #results {
      font-family: 'Kanit', sans-serif;
      background: #2c2c2c;
      /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
      padding: 2em;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      margin-bottom: 2.5em;
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    input,
    textarea {
      font-family: 'Kanit', sans-serif;
      display: block;
      margin-bottom: 1.2em;
      padding: 1em;
      width: 100%;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 1em;
      background-color: #3c3c3c;
      color: #ffffff;
      box-sizing: border-box;
    }

    input::placeholder, textarea::placeholder {
      color: #aaaaaa;
      font-family: 'Kanit', sans-serif;
    }

    /* ‡∏õ‡∏∏‡πà‡∏° */
    button {
      padding: 0.9em 1.8em;
      background-color: #007bff;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-family: 'Kanit', sans-serif;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
    .search-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 1em;
      background: #2c2c2c;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      margin-bottom: 2em;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    input#searchTitle {
      flex: 3; /* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ */
      padding: 0.8em;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 1em;
      background-color: #3c3c3c;
      color: #ffffff;
      box-sizing: border-box;
    }

    /* ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
    #results {
      margin-top: 2em;
      padding: 1em;
      background-color: #2c2c2c;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #results h3 {
      margin-bottom: 1em;
      color: #007bff;
    }

    #results div {
      margin-bottom: 1em;
      padding: 0.5em;
      border-bottom: 1px solid #444;
    }

    button[onclick="getReviews()"] {
      flex: 0.5; /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ */
      padding: 0.8em;
      background-color: #007bff;
      color: #ffffff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }


    button[onclick="getReviews()"]:hover {
      background-color: #0056b3;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .form-select {
      background-color: #3c3c3c;
      color: #ffffff;
      border: 1px solid #3c3c3c;
      padding: 8px;
      border-radius: 5px;
      font-size: 16px;
    }
  </style>
  </head>

  <body>
    <h1 class="mt-5">Movie Recommendation App üé•</h1>

    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</h2>
    <form id="reviewForm">
      <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
      <input type="text" id="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå" required>
      <input type="number" id="released" placeholder="‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏â‡∏≤‡∏¢" required>
      <input type="number" id="rating" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-10)" min="1" max="10" required>
      <textarea id="summary" name="summary" rows="3" cols="30"
        placeholder="‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå"></textarea>

      <label for="genres">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå:</label><br>
      <p style="color: #aaaaaa; font-size: small;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏≤‡∏á Ctrl (Windows) /
        Command (Mac) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</p>
      <select id="genres" name="genres[]" multiple size="5" class="form-select">
        <option value="action">Action</option>
        <option value="adventure">Adventure</option>
        <option value="comedy">Comedy</option>
        <option value="drama">Drama</option>
        <option value="thriller">Thriller</option>
        <option value="sci-fi">Sci-Fi</option>
        <option value="romance">Romance</option>
        <option value="crime">Crime</option>
        <option value="fantasy">Fantasy</option>
      </select>

      <br><br>

      <button type="submit"
        class="d-flex justify-content-center">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </form>

    <h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</h2>
    <div class="search-section">
      <input type="text" id="searchTitle"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏µ‡∏ß‡∏¥‡∏ß" style="margin-bottom: 0;">
      <button onclick="getReviews()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div id="results"></div>

    <script>
      const apiUrl = '/api';
      
      document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('name').value.trim();
        const movie_title = document.getElementById('title').value.trim();
        const year = parseInt(document.getElementById('released').value);
        const rating = parseFloat(document.getElementById('rating').value);
        const comment = document.getElementById('summary').value.trim();
        const genresSelect = document.getElementById('genres');
        const genres = Array.from(genresSelect.selectedOptions).map(option => option.value);
      
        const data = { username, movie_title, year, rating, comment, genres };
      
        try {
          const res = await fetch(`${apiUrl}/review`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          const result = await res.json();
          
          if (!res.ok) {
            throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
          }
          
          alert(result.message || '‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.getElementById('reviewForm').reset();
        } catch (err) {
          console.error(err);
          alert(err.message);
        }

      });
      
      async function getReviews() {
        const title = document.getElementById('searchTitle').value.trim();
        if (!title) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå');
          return;
        }
      
        const res = await fetch(`${apiUrl}/review/${encodeURIComponent(title)}`);
        const { reviews, similar_movies } = await res.json();
      
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
      
        if (reviews.length === 0) {
          resultsDiv.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>';
        } else {
          reviews.forEach(review => {
            const reviewDiv = document.createElement('div');
            reviewDiv.innerHTML = `
              <h3>${review.title} (${review.year || '-'})</h3>
              <p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> ${review.rating || '-'}</p>
              <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß:</strong> ${review.user || '-'}</p>
              <p><strong>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß:</strong> ${review.comment || '-'}</p>
              <p><strong>‡πÅ‡∏ô‡∏ß:</strong> ${review.genres.join(', ')}</p>
              <button onclick="editReview('${review.id}')" style="margin-right: 10px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button onclick="deleteReview('${review.id}')">‡∏•‡∏ö</button>
            `;
            resultsDiv.appendChild(reviewDiv);
          });
        }
      
        if (similar_movies.length > 0) {
          const similarDiv = document.createElement('div');
          similarDiv.innerHTML = '<h2>‡∏´‡∏ô‡∏±‡∏á‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</h2>';
          similar_movies.forEach(movie => {
            similarDiv.innerHTML += `
              <p><strong>${movie.title}</strong> (${movie.year || '-'}) - ${movie.genres.join(', ')} </p>
            `;
          });
          resultsDiv.appendChild(similarDiv);
        }
      }
      
      async function editReview(id) {
        const res = await fetch(`${apiUrl}/review-by-id/${encodeURIComponent(id)}`);
        const review = await res.json();
        const newSummary = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏µ‡∏ß‡∏¥‡∏ß:", review.comment);
        const newRating = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-10):", review.rating);
      
        if (newSummary === null || newRating === null) return;
      
        const updateRes = await fetch(`${apiUrl}/review/${encodeURIComponent(id)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ summary: newSummary.trim(), rating: Number(newRating) })
        });
      
        if (updateRes.ok) {
          alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          getReviews();
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
        }
      }
      
      async function deleteReview(id) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?')) return;
      
        const res = await fetch(`${apiUrl}/review/${encodeURIComponent(id)}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          getReviews();
        } else {
          const errorText = await res.text();
          console.error('‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', res.status, errorText);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ' + res.status);
        }
      }

      </script>

  </body>

</html>